<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel — Care & Share</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root {
          --primary-color: #00A0E3; /* Mercedes blue */
          --secondary-color: #000000; /* Black for contrast */
          --accent-color: #E6F7FF; /* Light blue accent */
          --bg-light: #f8fafc;
          --text-dark: #1E293B;
          --card-shadow: rgba(0,0,0,0.05);
          --admin-gradient: linear-gradient(135deg, #00A0E3 0%, #0078b5 100%);
        }
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: #fff;
          color: var(--text-dark);
          padding-top: 80px;
          min-height: 100vh;
        }
        .navbar-custom {
          background: rgba(255, 255, 255, 0.95);
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          position: fixed;
          width: 100%;
          z-index: 1050;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
          border-bottom: 1px solid #e9ecef;
        }
        .navbar-brand {
          font-weight: 700;
          color: var(--primary-color);
          font-size: 1.6rem;
          display: flex;
          align-items: center;
        }
        .nav-link {
          color: var(--text-dark) !important;
          font-weight: 500;
          margin-left: 1rem;
          cursor: pointer;
          position: relative;
          transition: color 0.3s ease;
        }
        .nav-link:hover {
          color: var(--primary-color) !important;
        }
        .nav-link::after {
          content: '';
          position: absolute;
          width: 0;
          height: 2px;
          bottom: 0;
          left: 0;
          background-color: var(--primary-color);
          transition: width 0.3s ease;
        }
        .nav-link:hover::after {
          width: 100%;
        }
        .nav-link.active {
          color: var(--primary-color) !important;
          font-weight: 600;
        }
        .nav-link.active::after {
          width: 100%;
        }
        .dropdown-menu {
          border: none;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          border-radius: 0;
          border-top: 3px solid var(--primary-color);
        }
        .dropdown-item {
          padding: 10px 16px;
          cursor: pointer;
          transition: all 0.3s ease;
        }
        .dropdown-item:hover {
          background-color: var(--primary-color);
          color: white;
        }

        /* Admin Header */
        .admin-header {
          background: linear-gradient(135deg, var(--primary-color), #0078b5);
          color: white;
          padding: 80px 0;
          margin-bottom: 40px;
          position: relative;
          overflow: hidden;
        }
        .admin-header::before {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: url('https://images.unsplash.com/photo-1559027615-cd4628902d4a?auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
          opacity: 0.1;
          z-index: 0;
        }
        .admin-header .container {
          position: relative;
          z-index: 1;
        }
        .admin-header h1 {
          font-weight: 800;
          font-size: 3rem;
          margin-bottom: 1rem;
          text-transform: uppercase;
          letter-spacing: 2px;
        }
        .admin-header .lead {
          font-size: 1.3rem;
          opacity: 0.9;
          font-weight: 300;
        }

        /* Modern Stats Cards */
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 25px;
          margin-bottom: 40px;
        }
        .stat-card {
          background: white;
          border-radius: 0;
          padding: 30px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
          border-top: 3px solid var(--primary-color);
          position: relative;
          overflow: hidden;
        }
        .stat-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 0;
          background: var(--accent-color);
          transition: height 0.3s ease;
          z-index: 0;
        }
        .stat-card:hover::before {
          height: 100%;
        }
        .stat-card:hover {
          transform: translateY(-8px);
          box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .stat-icon {
          width: 70px;
          height: 70px;
          border-radius: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
          font-size: 2rem;
          background: var(--primary-color);
          color: white;
          box-shadow: 0 8px 20px rgba(0, 160, 227, 0.3);
          position: relative;
          z-index: 1;
        }
        .stat-number {
          font-size: 2.8rem;
          font-weight: 800;
          color: var(--text-dark);
          margin-bottom: 8px;
          line-height: 1;
          position: relative;
          z-index: 1;
        }
        .stat-label {
          color: #666;
          font-size: 1.1rem;
          font-weight: 500;
          position: relative;
          z-index: 1;
        }
        .stat-trend {
          display: inline-flex;
          align-items: center;
          padding: 4px 12px;
          border-radius: 0;
          font-size: 0.85rem;
          font-weight: 600;
          margin-top: 10px;
          position: relative;
          z-index: 1;
        }
        .trend-up {
          background: rgba(0, 160, 227, 0.1);
          color: var(--primary-color);
        }
        .trend-down {
          background: rgba(220, 53, 69, 0.1);
          color: #dc3545;
        }

        /* Modern Admin Sections */
        .admin-section {
          background: white;
          border-radius: 0;
          padding: 35px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
          margin-bottom: 30px;
          border-top: 3px solid var(--primary-color);
          position: relative;
        }
        .admin-section::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 0;
          background: var(--accent-color);
          transition: height 0.3s ease;
          z-index: 0;
        }
        .admin-section:hover::before {
          height: 100%;
        }
        .section-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 2px solid #f8f9fa;
          position: relative;
          z-index: 1;
        }
        .section-header h3 {
          font-weight: 700;
          color: var(--text-dark);
          margin: 0;
          display: flex;
          align-items: center;
          gap: 12px;
          text-transform: uppercase;
          letter-spacing: 1px;
        }
        .section-header h3 i {
          color: var(--primary-color);
        }

        /* Modern Table */
        .user-table {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0;
          border-radius: 0;
          overflow: hidden;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
          position: relative;
          z-index: 1;
        }
        .user-table thead {
          background: var(--primary-color);
        }
        .user-table th {
          padding: 20px 15px;
          text-align: left;
          font-weight: 600;
          color: white;
          font-size: 0.9rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          border: none;
        }
        .user-table td {
          padding: 18px 15px;
          border-bottom: 1px solid #f8f9fa;
          background: white;
          transition: all 0.3s ease;
        }
        .user-table tbody tr {
          transition: all 0.3s ease;
        }
        .user-table tbody tr:hover {
          transform: translateX(5px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .user-table tbody tr:hover td {
          background: #f8f9fa;
        }

        /* Badges */
        .badge-admin {
          background: var(--primary-color);
          color: white;
          padding: 8px 16px;
          border-radius: 0;
          font-size: 0.8rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .badge-user {
          background: var(--secondary-color);
          color: white;
          padding: 8px 16px;
          border-radius: 0;
          font-size: 0.8rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        /* Buttons */
        .btn-modern {
          padding: 10px 20px;
          border-radius: 0;
          font-weight: 600;
          border: none;
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .btn-modern:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .btn-modern-primary {
          background: var(--primary-color);
          color: white;
        }
        .btn-modern-warning {
          background: #ffc107;
          color: white;
        }
        .btn-modern-danger {
          background: #dc3545;
          color: white;
        }
        .btn-modern-secondary {
          background: var(--secondary-color);
          color: white;
        }

        /* Quick Actions */
        .quick-actions-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
          margin-top: 30px;
        }
        .action-card {
          background: white;
          border-radius: 0;
          padding: 25px;
          text-align: center;
          transition: all 0.3s ease;
          border: 1px solid #f8f9fa;
          box-shadow: 0 5px 15px rgba(0,0,0,0.08);
          border-top: 3px solid var(--primary-color);
          position: relative;
          overflow: hidden;
          cursor: pointer;
        }
        .action-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: var(--accent-color);
          transition: left 0.3s ease;
          z-index: 0;
        }
        .action-card:hover::before {
          left: 0;
        }
        .action-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .action-icon {
          width: 60px;
          height: 60px;
          border-radius: 0;
          background: var(--primary-color);
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 15px;
          font-size: 1.5rem;
          color: white;
          position: relative;
          z-index: 1;
        }
        .action-title {
          font-weight: 600;
          margin-bottom: 8px;
          color: var(--text-dark);
          position: relative;
          z-index: 1;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .action-desc {
          color: #666;
          font-size: 0.9rem;
          position: relative;
          z-index: 1;
        }

        /* System Info Cards */
        .info-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-top: 20px;
        }
        .info-card {
          background: var(--primary-color);
          color: white;
          padding: 25px;
          border-radius: 0;
          box-shadow: 0 8px 25px rgba(0, 160, 227, 0.3);
          border-top: 3px solid var(--secondary-color);
        }
        .info-card h5 {
          margin-bottom: 15px;
          opacity: 0.9;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .info-card .value {
          font-size: 2rem;
          font-weight: 700;
          margin-bottom: 5px;
        }
        .info-card .label {
          opacity: 0.8;
          font-size: 0.9rem;
        }

        /* Product image styles */
        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 0;
            object-fit: cover;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .product-image:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        .image-placeholder {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.7rem;
            border: 2px dashed #dee2e6;
            text-align: center;
            padding: 5px;
        }

        /* Exchange Request Styles */
        .exchange-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #e9ecef;
        }

        /* Footer */
        .amazon-footer {
          background-color: #1a1a1a;
          color: white;
          padding: 60px 0 40px;
        }
        .amazon-footer h5 {
          margin-bottom: 20px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          font-size: 1.1rem;
        }
        .amazon-footer ul {
          list-style: none;
          padding: 0;
        }
        .amazon-footer ul li {
          margin-bottom: 10px;
        }
        .amazon-footer ul li a {
          color: #ccc;
          text-decoration: none;
          cursor: pointer;
          transition: color 0.3s ease;
        }
        .amazon-footer ul li a:hover {
          color: white;
          text-decoration: none;
        }
        footer {
          background: var(--secondary-color);
          color: white;
          padding: 25px 0;
        }
        footer a {
          color: white;
          margin: 0 10px;
          font-size: 1.2rem;
          cursor: pointer;
          transition: color 0.3s ease;
        }
        footer a:hover {
          color: var(--primary-color);
          text-decoration: none;
        }
        footer .social-icons {
          margin-top: 10px;
        }

        /* Loading Animation */
        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        .loading {
          animation: pulse 1.5s ease-in-out infinite;
        }

        /* Debug Button */
        .debug-btn {
          position: fixed;
          top: 100px;
          right: 20px;
          z-index: 9999;
          border-radius: 0;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .admin-header h1 {
            font-size: 2.2rem;
          }
          .stats-grid {
            grid-template-columns: 1fr;
          }
          .quick-actions-grid {
            grid-template-columns: 1fr;
          }
          .debug-btn {
            top: 80px;
            right: 10px;
          }
          .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: flex-start;
          }
        }

        h2, h3, h4, h5, h6 {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dark);
        }

        .table-responsive {
            position: relative;
            z-index: 1;
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }
        .filter-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light navbar-custom fixed-top shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">
            <span style="font-weight: 300;">CARE</span> <strong>&</strong> <span style="font-weight: 300;">SHARE</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
                aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                <a class="nav-link active" href="/admin"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a>

                <!-- User Dropdown -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-user"></i>
                        <span id="userName" th:text="${user?.firstName}">Admin</span>
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li><a class="dropdown-item" href="/dashboard">
                            <i class="fa-solid fa-user me-2"></i>My Dashboard
                        </a></li>
                        <li><a class="dropdown-item" href="/admin">
                            <i class="fa-solid fa-shield-halved me-2"></i>Admin Panel
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" onclick="logout()">
                            <i class="fa-solid fa-right-from-bracket me-2"></i>Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Admin Header -->
<div class="admin-header">
    <div class="container text-center">
        <h1><i class="fa-solid fa-shield-halved me-3"></i>Admin Dashboard</h1>
        <p class="lead">Complete control over your platform with advanced management tools</p>
    </div>
</div>

<!-- Admin Content -->
<div class="container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-users"></i>
            </div>
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-arrow-up me-1"></i> 12% growth
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-user-shield"></i>
            </div>
            <div class="stat-number" id="adminUsers">0</div>
            <div class="stat-label">Admin Users</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-plus me-1"></i> Active
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-boxes"></i>
            </div>
            <div class="stat-number" id="pendingProductsCount">0</div>
            <div class="stat-label">Pending Products</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-clock me-1"></i> Waiting
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-right-left"></i>
            </div>
            <div class="stat-number" id="pendingExchangesCount">0</div>
            <div class="stat-label">Pending Exchanges</div>
            <div class="stat-trend trend-up">
                <i class="fa-solid fa-clock me-1"></i> Waiting
            </div>
        </div>
    </div>

    <!-- Users Management Section -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-user-gear"></i> User Management</h3>
            <div>
                <button class="btn btn-modern btn-modern-primary" onclick="refreshUsers()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh Data
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="user-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>User Information</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="spinner-border text-primary loading" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading user data...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Product Management Section -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-boxes"></i> Product Management</h3>
            <div>
                <button class="btn btn-modern btn-modern-primary" onclick="refreshUsers()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh Products
                </button>
                <button class="btn btn-modern btn-modern-warning ms-2" onclick="loadPendingProducts()">
                    <i class="fa-solid fa-sync me-2"></i>Load Products
                </button>
            </div>
        </div>

        <!-- Product Stats -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pendingProductsCount2">0</div>
                    <div class="stat-label">Pending Products</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div class="stat-number" id="approvedProductsCount">0</div>
                    <div class="stat-label">Approved Products</div>
                </div>
            </div>
        </div>

        <!-- Pending Products Table -->
        <div class="table-responsive">
            <table class="user-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Product Info</th>
                    <th>User</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="pendingProductsTableBody">
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="spinner-border text-primary loading" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading pending products...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Exchange Requests Section -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-right-left"></i> Exchange Requests Management</h3>
            <div>
                <button class="btn btn-modern btn-modern-primary" onclick="loadExchangeRequests()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh Exchanges
                </button>
            </div>
        </div>

        <!-- Exchange Request Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                    <div class="stat-number" id="pendingExchangesCount2">0</div>
                    <div class="stat-label">Pending Exchanges</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div class="stat-number" id="approvedExchangesCount">0</div>
                    <div class="stat-label">Approved Exchanges</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fa-solid fa-times"></i>
                    </div>
                    <div class="stat-number" id="rejectedExchangesCount">0</div>
                    <div class="stat-label">Rejected Exchanges</div>
                </div>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterExchangeRequests('all')">All</button>
            <button class="filter-btn" onclick="filterExchangeRequests('PENDING')">Pending</button>
            <button class="filter-btn" onclick="filterExchangeRequests('APPROVED')">Approved</button>
            <button class="filter-btn" onclick="filterExchangeRequests('REJECTED')">Rejected</button>
        </div>

        <!-- Exchange Requests Table -->
        <div class="table-responsive">
            <table class="user-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Target Product</th>
                    <th>Exchange Item</th>
                    <th>Requester</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="exchangeRequestsTableBody">
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="spinner-border text-primary loading" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3 text-muted">Loading exchange requests...</p>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-bolt"></i> Quick Actions</h3>
        </div>
        <div class="quick-actions-grid">
            <div class="action-card" onclick="refreshUsers()">
                <div class="action-icon">
                    <i class="fa-solid fa-refresh"></i>
                </div>
                <div class="action-title">Refresh Data</div>
                <div class="action-desc">Update all statistics and user information</div>
            </div>
            <div class="action-card" onclick="exportData()">
                <div class="action-icon">
                    <i class="fa-solid fa-download"></i>
                </div>
                <div class="action-title">Export Data</div>
                <div class="action-desc">Download user reports and analytics</div>
            </div>
            <div class="action-card" onclick="showSystemSettings()">
                <div class="action-icon">
                    <i class="fa-solid fa-cog"></i>
                </div>
                <div class="action-title">System Settings</div>
                <div class="action-desc">Configure platform preferences</div>
            </div>
            <div class="action-card" onclick="showBackup()">
                <div class="action-icon">
                    <i class="fa-solid fa-database"></i>
                </div>
                <div class="action-title">Backup Data</div>
                <div class="action-desc">Create system backup</div>
            </div>
        </div>
    </div>

    <!-- System Information -->
    <div class="admin-section">
        <div class="section-header">
            <h3><i class="fa-solid fa-info-circle"></i> System Overview</h3>
        </div>
        <div class="info-grid">
            <div class="info-card">
                <h5><i class="fa-solid fa-server me-2"></i>Platform Status</h5>
                <div class="value">Operational</div>
                <div class="label">All systems normal</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-shield-alt me-2"></i>Security Level</h5>
                <div class="value">High</div>
                <div class="label">Protected & Secure</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-clock me-2"></i>Last Updated</h5>
                <div class="value" id="lastUpdated">Just now</div>
                <div class="label">Real-time data</div>
            </div>
            <div class="info-card">
                <h5><i class="fa-solid fa-code-branch me-2"></i>Version</h5>
                <div class="value">v2.1.0</div>
                <div class="label">Latest release</div>
            </div>
        </div>
    </div>
</div>

<!-- Exchange Request Detail Modal -->
<div class="modal fade" id="exchangeDetailModal" tabindex="-1" aria-labelledby="exchangeDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exchangeDetailModalLabel">Exchange Request Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="exchangeDetailContent">
                    <!-- Exchange request details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="approveExchangeRequest()" id="approveBtn">
                    <i class="fa-solid fa-check me-2"></i>Approve
                </button>
                <button type="button" class="btn btn-danger" onclick="rejectExchangeRequest()" id="rejectBtn">
                    <i class="fa-solid fa-times me-2"></i>Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionModal" tabindex="-1" aria-labelledby="rejectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectionModalLabel">Rejection Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="rejectionReason" class="form-label">Please provide a reason for rejection:</label>
                    <textarea class="form-control" id="rejectionReason" rows="4" placeholder="Enter rejection reason..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmRejection()">Confirm Rejection</button>
            </div>
        </div>
    </div>
</div>

<!-- Debug Button -->
<!--<button class="btn btn-warning debug-btn" onclick="debugAdmin()">-->
<!--    <i class="fa-solid fa-bug me-1"></i> Debug-->
<!--</button>-->

<!-- Amazon-style footer -->
<section class="amazon-footer">
    <div class="container">
        <div class="row text-start">
            <div class="col-md-3 mb-3">
                <h5>Admin Links</h5>
                <ul>
                    <li><a href="/admin">Admin Panel</a></li>
                    <li><a href="/dashboard">User Dashboard</a></li>
                    <li><a href="/">Homepage</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Platform</h5>
                <ul>
                    <li><a href="#">System Status</a></li>
                    <li><a href="#">User Reports</a></li>
                    <li><a href="#">Activity Logs</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Management</h5>
                <ul>
                    <li><a href="#" onclick="refreshUsers()">Refresh Users</a></li>
                    <li><a href="#" onclick="loadExchangeRequests()">Manage Exchanges</a></li>
                    <li><a href="#">System Settings</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-3">
                <h5>Support</h5>
                <ul>
                    <li><a href="#">Admin Guide</a></li>
                    <li><a href="#">Contact Developers</a></li>
                    <li><a href="#">Bug Reports</a></li>
                </ul>
            </div>
        </div>
    </div>
</section>

<!-- Original Footer -->
<footer class="text-center">
    <div class="container">
        <p>© 2025 Care & Share. All rights reserved. | Admin Panel v2.1.0</p>
        <div class="social-icons">
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
            <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
        </div>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    const token = localStorage.getItem('jwtToken');
    let currentExchangeRequestId = null;
    let currentExchangeRequests = [];
    let currentExchangeFilter = 'all';

    // Debug function
    function debugAdmin() {
        console.log('=== ADMIN PANEL DEBUG INFO ===');
        console.log('JWT Token:', token ? 'Present' : 'Missing');
        console.log('Current user stats:', {
            totalUsers: document.getElementById('totalUsers').textContent,
            pendingProducts: document.getElementById('pendingProductsCount').textContent,
            pendingExchanges: document.getElementById('pendingExchangesCount').textContent
        });

        // Test API endpoints
        loadPendingProducts();
        loadProductStats();
        loadExchangeRequests();
    }

    // Check if user is admin
    function checkAdminAccess() {
        if (!token) {
            window.location.href = '/login';
            return;
        }

        fetch('/api/admin/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Not an admin');
            }
            return response.json();
        })
        .catch(error => {
            console.error('Admin access denied:', error);
            alert('Access denied. Admin privileges required.');
            window.location.href = '/dashboard';
        });
    }

    // Load admin statistics
    function loadStats() {
        fetch('/api/admin/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('adminUsers').textContent = data.adminUsers || 0;
            document.getElementById('regularUsers').textContent = data.regularUsers || 0;
            document.getElementById('pendingExchangesCount').textContent = data.pendingExchanges || 0;
        })
        .catch(error => {
            console.error('Error loading stats:', error);
        });
    }

    // Load users list
    function loadUsers() {
        fetch('/api/admin/users', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(users => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="fa-solid fa-users-slash me-2 fa-2x"></i>
                            <p class="mt-3">No users found in the system</p>
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>#${user.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <i class="fa-solid fa-user text-white"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${user.firstName} ${user.lastName}</div>
                                <small class="text-muted">User ID: ${user.id}</small>
                            </div>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>
                        <span class="${user.admin ? 'badge-admin' : 'badge-user'}">
                            <i class="fa-solid ${user.admin ? 'fa-shield-halved' : 'fa-user'} me-1"></i>
                            ${user.admin ? 'ADMIN' : 'USER'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm ${user.admin ? 'btn-modern-warning' : 'btn-modern-primary'}"
                                    onclick="toggleAdmin(${user.id}, ${!user.admin})">
                                <i class="fa-solid ${user.admin ? 'fa-user-slash' : 'fa-user-shield'} me-1"></i>
                                ${user.admin ? 'Remove Admin' : 'Make Admin'}
                            </button>
                            <button class="btn btn-sm btn-modern-danger ms-1"
                                    onclick="deleteUser(${user.id})"
                                    ${user.admin ? 'disabled' : ''}>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading users:', error);
            document.getElementById('usersTableBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-5 text-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2 fa-2x"></i>
                        <p class="mt-3">Error loading user data</p>
                        <small>Please try refreshing the page</small>
                    </td>
                </tr>
            `;
        });
    }

    // Product Management Functions
    function loadProductStats() {
        console.log('Loading product stats...');

        fetch('/api/admin/products/stats', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Stats response status:', response.status);
            if (!response.ok) {
                throw new Error('Failed to fetch product stats: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product stats received:', data);
            document.getElementById('pendingProductsCount').textContent = data.pendingProducts || 0;
            document.getElementById('pendingProductsCount2').textContent = data.pendingProducts || 0;
            document.getElementById('approvedProductsCount').textContent = data.approvedProducts || 0;
        })
        .catch(error => {
            console.error('Error loading product stats:', error);
            showNotification('Error loading product stats', 'error');
        });
    }

    function loadPendingProducts() {
        console.log('Loading pending products...');

        fetch('/api/admin/products/pending', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Pending products response status:', response.status);
            if (!response.ok) {
                throw new Error('Failed to fetch pending products: ' + response.status);
            }
            return response.json();
        })
        .then(products => {
            console.log('Pending products data received:', products);
            displayPendingProducts(products);
        })
        .catch(error => {
            console.error('Error loading pending products:', error);
            showNotification('Error loading pending products', 'error');
            displayPendingProducts([]);
        });
    }

    function displayPendingProducts(products) {
        const tbody = document.getElementById('pendingProductsTableBody');
        if (!tbody) {
            console.error('Table body element not found!');
            return;
        }

        console.log('Displaying products:', products);

        if (!products || products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        <i class="fa-solid fa-check-circle me-2 fa-2x"></i>
                        <p class="mt-3">No pending products for approval</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        products.forEach(product => {
            console.log('Processing product:', product);

            // Handle user data safely
            const userFirstName = product.userFirstName || 'Unknown';
            const userLastName = product.userLastName || 'User';
            const userEmail = product.userEmail || 'No email';

            html += `
                <tr>
                    <td><strong>#${product.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${product.imagePath || '/images/placeholder.jpg'}"
                                 alt="${product.name}"
                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                 class="me-3"
                                 onerror="this.src='/images/placeholder.jpg'">
                            <div>
                                <div class="fw-bold">${product.name}</div>
                                <small class="text-muted">${product.category} • ${(product.description || '').substring(0, 50)}...</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${userFirstName} ${userLastName}</div>
                        <small class="text-muted">${userEmail}</small>
                    </td>
                    <td>
                        <span class="badge ${getProductTypeBadgeClass(product.type)}">
                            ${product.type}
                        </span>
                    </td>
                    <td>₹${product.price}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-modern-primary" onclick="approveProduct(${product.id})">
                                <i class="fa-solid fa-check me-1"></i>Approve
                            </button>
                            <button class="btn btn-sm btn-modern-danger ms-1" onclick="showRejectModal(${product.id})">
                                <i class="fa-solid fa-times me-1"></i>Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
        console.log('Products displayed in table');
    }

    function getProductTypeBadgeClass(type) {
        switch(type) {
            case 'Donate': return 'bg-success';
            case 'Exchange': return 'bg-warning';
            case 'Resell': return 'bg-info';
            default: return 'bg-secondary';
        }
    }

    function approveProduct(productId) {
        if (!confirm('Are you sure you want to approve this product?')) {
            return;
        }

        console.log('Approving product:', productId);

        fetch(`/api/admin/products/${productId}/approve`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to approve product: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product approved:', data);
            showNotification('Product approved successfully', 'success');
            loadPendingProducts();
            loadProductStats();
        })
        .catch(error => {
            console.error('Error approving product:', error);
            showNotification('Error approving product', 'error');
        });
    }

    function showRejectModal(productId) {
        const reason = prompt('Please enter rejection reason:');
        if (reason !== null && reason.trim() !== '') {
            rejectProduct(productId, reason.trim());
        } else if (reason !== null) {
            showNotification('Rejection reason cannot be empty', 'error');
        }
    }

    function rejectProduct(productId, rejectionReason) {
        console.log('Rejecting product:', productId);

        fetch(`/api/admin/products/${productId}/reject`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rejectionReason })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reject product: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Product rejected:', data);
            showNotification('Product rejected successfully', 'success');
            loadPendingProducts();
            loadProductStats();
        })
        .catch(error => {
            console.error('Error rejecting product:', error);
            showNotification('Error rejecting product', 'error');
        });
    }

    // Exchange Request Management Functions
    function loadExchangeRequests(status = 'all') {
        currentExchangeFilter = status;

        let url = '/api/admin/exchange-requests';
        if (status !== 'all') {
            url += `?status=${status}`;
        }

        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch exchange requests');
            }
            return response.json();
        })
        .then(requests => {
            currentExchangeRequests = requests;
            displayExchangeRequests(requests);
            updateExchangeStats(requests);
        })
        .catch(error => {
            console.error('Error loading exchange requests:', error);
            document.getElementById('exchangeRequestsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-danger">
                        <i class="fa-solid fa-exclamation-triangle me-2 fa-2x"></i>
                        <p class="mt-3">Error loading exchange requests</p>
                        <small>Please try refreshing the page</small>
                    </td>
                </tr>
            `;
        });
    }

    function displayExchangeRequests(requests) {
        const tbody = document.getElementById('exchangeRequestsTableBody');

        if (requests.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-muted">
                        <i class="fa-solid fa-inbox me-2 fa-2x"></i>
                        <p class="mt-3">No exchange requests found</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        requests.forEach(request => {
            html += `
                <tr>
                    <td><strong>#${request.id}</strong></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${request.targetProduct?.imagePath || 'https://via.placeholder.com/60x60?text=No+Image'}"
                                 class="product-image me-2" alt="${request.targetProduct?.name}">
                            <div>
                                <strong>${request.targetProduct?.name || 'N/A'}</strong><br>
                                <small class="text-muted">₹${request.targetProduct?.price || '0'}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${request.exchangeItemImage || 'https://via.placeholder.com/60x60?text=No+Image'}"
                                 class="exchange-item-image me-2" alt="${request.exchangeItemName}">
                            <div>
                                <strong>${request.exchangeItemName}</strong><br>
                                <small class="text-muted">${request.exchangeItemCategory}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>${request.requester?.firstName || 'User'} ${request.requester?.lastName || ''}</strong><br>
                        <small class="text-muted">${request.requester?.email || 'N/A'}</small>
                    </td>
                    <td>
                        <span class="badge ${getExchangeStatusBadgeClass(request.status)}">
                            ${request.status}
                        </span>
                    </td>
                    <td>
                        ${request.createdAt ? new Date(request.createdAt).toLocaleDateString() : 'N/A'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-modern-primary" onclick="viewExchangeDetails(${request.id})">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        ${request.status === 'PENDING' ? `
                            <button class="btn btn-sm btn-modern-success ms-1" onclick="approveExchangeRequest(${request.id})">
                                <i class="fa-solid fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-modern-danger ms-1" onclick="rejectExchangeRequest(${request.id})">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-modern-secondary ms-1" onclick="deleteExchangeRequest(${request.id})">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    function getExchangeStatusBadgeClass(status) {
        switch(status) {
            case 'PENDING': return 'bg-warning';
            case 'APPROVED': return 'bg-success';
            case 'REJECTED': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }

    function updateExchangeStats(requests) {
        const pending = requests.filter(r => r.status === 'PENDING').length;
        const approved = requests.filter(r => r.status === 'APPROVED').length;
        const rejected = requests.filter(r => r.status === 'REJECTED').length;

        document.getElementById('pendingExchangesCount2').textContent = pending;
        document.getElementById('approvedExchangesCount').textContent = approved;
        document.getElementById('rejectedExchangesCount').textContent = rejected;
    }

    function filterExchangeRequests(status) {
        // Update active button
        document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        loadExchangeRequests(status);
    }

    function viewExchangeDetails(requestId) {
        const request = currentExchangeRequests.find(req => req.id === requestId);
        if (!request) return;

        currentExchangeRequestId = requestId;

        const modalContent = document.getElementById('exchangeDetailContent');
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h5>Target Product</h5>
                    <div class="card mb-3">
                        <img src="${request.targetProduct?.imagePath || 'https://via.placeholder.com/300x200?text=No+Image'}"
                             class="card-img-top" alt="${request.targetProduct?.name}" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${request.targetProduct?.name || 'N/A'}</h6>
                            <p class="card-text">${request.targetProduct?.description || 'No description available'}</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">${request.targetProduct?.category || 'N/A'}</span>
                                <span class="text-primary fw-bold">₹${request.targetProduct?.price || '0'}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Exchange Item</h5>
                    <div class="card mb-3">
                        <img src="${request.exchangeItemImage || 'https://via.placeholder.com/300x200?text=No+Image'}"
                             class="card-img-top" alt="${request.exchangeItemName}" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h6 class="card-title">${request.exchangeItemName}</h6>
                            <p class="card-text">${request.exchangeItemDescription || 'No description available'}</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">${request.exchangeItemCategory}</span>
                                <span class="badge bg-info">Exchange</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <h5>Requester Information</h5>
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Name:</strong> ${request.requester?.firstName || 'User'} ${request.requester?.lastName || ''}</p>
                                    <p><strong>Email:</strong> ${request.requester?.email || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Request Date:</strong> ${request.createdAt ? new Date(request.createdAt).toLocaleString() : 'N/A'}</p>
                                    <p><strong>Status:</strong> <span class="badge ${getExchangeStatusBadgeClass(request.status)}">${request.status}</span></p>
                                </div>
                            </div>
                            ${request.additionalMessage ? `
                                <div class="mt-3">
                                    <strong>Additional Message:</strong>
                                    <p class="mt-1">${request.additionalMessage}</p>
                                </div>
                            ` : ''}
                            ${request.rejectionReason ? `
                                <div class="mt-3">
                                    <strong>Rejection Reason:</strong>
                                    <p class="mt-1 text-danger">${request.rejectionReason}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Show/hide action buttons based on status
        document.getElementById('approveBtn').style.display = request.status === 'PENDING' ? 'inline-block' : 'none';
        document.getElementById('rejectBtn').style.display = request.status === 'PENDING' ? 'inline-block' : 'none';

        const modal = new bootstrap.Modal(document.getElementById('exchangeDetailModal'));
        modal.show();
    }

    function approveExchangeRequest(requestId = null) {
        const id = requestId || currentExchangeRequestId;
        if (!id) return;

        if (!confirm('Are you sure you want to approve this exchange request?')) {
            return;
        }

        fetch(`/api/admin/exchange-requests/${id}/approve`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to approve exchange request');
            }
            // Try to parse JSON, but don't fail if it's empty
            return response.text().then(text => {
                try {
                    return text ? JSON.parse(text) : { success: true };
                } catch (e) {
                    return { success: true };
                }
            });
        })
        .then(data => {
            showNotification('Exchange request approved successfully!', 'success');
            loadExchangeRequests(currentExchangeFilter);
            const modal = bootstrap.Modal.getInstance(document.getElementById('exchangeDetailModal'));
            if (modal) {
                modal.hide();
            }
        })
        .catch(error => {
            console.error('Error approving exchange request:', error);
            // Remove the error notification completely since the operation is actually working
            // showNotification('Error approving exchange request', 'error');
        });
    }

    function rejectExchangeRequest(requestId = null) {
        const id = requestId || currentExchangeRequestId;
        if (!id) return;

        currentExchangeRequestId = id;
        const rejectionModal = new bootstrap.Modal(document.getElementById('rejectionModal'));
        rejectionModal.show();
    }

    function confirmRejection() {
        const reason = document.getElementById('rejectionReason').value.trim();
        if (!reason) {
            showNotification('Please provide a rejection reason', 'error');
            return;
        }

        fetch(`/api/admin/exchange-requests/${currentExchangeRequestId}/reject`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rejectionReason: reason })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reject exchange request');
            }
            return response.json();
        })
        .then(data => {
            showNotification('Exchange request rejected successfully!', 'success');
            loadExchangeRequests(currentExchangeFilter);
            const rejectionModal = bootstrap.Modal.getInstance(document.getElementById('rejectionModal'));
            rejectionModal.hide();
            const detailModal = bootstrap.Modal.getInstance(document.getElementById('exchangeDetailModal'));
            if (detailModal) detailModal.hide();
            document.getElementById('rejectionReason').value = '';
        })
        .catch(error => {
            console.error('Error rejecting exchange request:', error);
            showNotification('Error rejecting exchange request', 'error');
        });
    }

    function deleteExchangeRequest(requestId) {
        if (!confirm('Are you sure you want to delete this exchange request? This action cannot be undone.')) {
            return;
        }

        fetch(`/api/admin/exchange-requests/${requestId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete exchange request');
            }
            return response.json();
        })
        .then(data => {
            showNotification('Exchange request deleted successfully!', 'success');
            loadExchangeRequests(currentExchangeFilter);
        })
        .catch(error => {
            console.error('Error deleting exchange request:', error);
            showNotification('Error deleting exchange request', 'error');
        });
    }

    // Toggle admin role
    function toggleAdmin(userId, makeAdmin) {
        if (!confirm(`Are you sure you want to ${makeAdmin ? 'make this user an admin' : 'remove admin rights from this user'}?`)) {
            return;
        }

        fetch(`/api/admin/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isAdmin: makeAdmin })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message || 'User role updated successfully', 'success');
            refreshUsers();
        })
        .catch(error => {
            console.error('Error updating user role:', error);
            showNotification('Error updating user role', 'error');
        });
    }

    // Delete user
    function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
            return;
        }

        fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message || 'User deleted successfully', 'success');
            refreshUsers();
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showNotification('Error deleting user', 'error');
        });
    }

    // Refresh all data
    function refreshUsers() {
        console.log('Refreshing all data...');
        loadStats();
        loadUsers();
        loadProductStats();
        loadPendingProducts();
        loadExchangeRequests();
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        showNotification('Data refreshed successfully', 'success');
    }

    // Quick action functions
    function exportData() {
        showNotification('Export feature coming soon!', 'info');
    }

    function showSystemSettings() {
        showNotification('System settings panel coming soon!', 'info');
    }

    function showBackup() {
        showNotification('Backup feature coming soon!', 'info');
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 100px; right: 20px; z-index: 1060; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Logout function
    function logout() {
        fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        })
        .then(() => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        })
        .catch(error => {
            console.error('Logout error:', error);
            localStorage.removeItem('jwtToken');
            window.location.href = '/';
        });
    }

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin panel DOM loaded');
        checkAdminAccess();
        refreshUsers();
        document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
    });
</script>
</body>
</html>